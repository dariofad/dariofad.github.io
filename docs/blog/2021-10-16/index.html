<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content="light dark" name=color-scheme><title>How to upgrade the Kernel (beginner)</title><meta content="<p>In this post I'll show you how to build and install the latest
Kernel version available to your system, possibly enabling the
Landlock LSM module.</p>
" name=description><link href=/img/favicon-32x32.png rel=icon sizes=32x32 type=image/png><link href=/img/favicon-16x16.png rel=icon sizes=16x16 type=image/png><link href=/img/apple-touch-icon.png rel=apple-touch-icon sizes=180x180><link href=https://fonts.googleapis.com rel=preconnect><link crossorigin href=https://fonts.gstatic.com rel=preconnect><link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel=stylesheet><link href=/main.css rel=stylesheet><body class=post><script>if(localStorage.getItem(`theme`)==`dark`)document.body.classList.add(`dark`)</script><header class=blur><div id=wrapper><nav><a href=/>Home</a><span class=separator>-</span><a href=https://dariofad.github.io/blog/>blog</a></nav><div id=btns><button aria-label="theme switch" data-moon-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M10 7C10 10.866 13.134 14 17 14C18.9584 14 20.729 13.1957 21.9995 11.8995C22 11.933 22 11.9665 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C12.0335 2 12.067 2 12.1005 2.00049C10.8043 3.27098 10 5.04157 10 7ZM4 12C4 16.4183 7.58172 20 12 20C15.0583 20 17.7158 18.2839 19.062 15.7621C18.3945 15.9187 17.7035 16 17 16C12.0294 16 8 11.9706 8 7C8 6.29648 8.08133 5.60547 8.2379 4.938C5.71611 6.28423 4 8.9417 4 12Z" fill="currentColor"></path></svg>' data-sun-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M12 18C8.68629 18 6 15.3137 6 12C6 8.68629 8.68629 6 12 6C15.3137 6 18 8.68629 18 12C18 15.3137 15.3137 18 12 18ZM12 16C14.2091 16 16 14.2091 16 12C16 9.79086 14.2091 8 12 8C9.79086 8 8 9.79086 8 12C8 14.2091 9.79086 16 12 16ZM11 1H13V4H11V1ZM11 20H13V23H11V20ZM3.51472 4.92893L4.92893 3.51472L7.05025 5.63604L5.63604 7.05025L3.51472 4.92893ZM16.9497 18.364L18.364 16.9497L20.4853 19.0711L19.0711 20.4853L16.9497 18.364ZM19.0711 3.51472L20.4853 4.92893L18.364 7.05025L16.9497 5.63604L19.0711 3.51472ZM5.63604 16.9497L7.05025 18.364L4.92893 20.4853L3.51472 19.0711L5.63604 16.9497ZM23 11V13H20V11H23ZM4 11V13H1V11H4Z" fill="currentColor"></path></svg>' id=theme-toggle><svg viewbox="0 0 24 24" height=24 width=24 xmlns=http://www.w3.org/2000/svg><path d="M10 7C10 10.866 13.134 14 17 14C18.9584 14 20.729 13.1957 21.9995 11.8995C22 11.933 22 11.9665 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C12.0335 2 12.067 2 12.1005 2.00049C10.8043 3.27098 10 5.04157 10 7ZM4 12C4 16.4183 7.58172 20 12 20C15.0583 20 17.7158 18.2839 19.062 15.7621C18.3945 15.9187 17.7035 16 17 16C12.0294 16 8 11.9706 8 7C8 6.29648 8.08133 5.60547 8.2379 4.938C5.71611 6.28423 4 8.9417 4 12Z" fill=currentColor></path></svg></button><button aria-label="table of content" id=toc-toggle><svg viewbox="0 0 24 24" height=24 width=24 xmlns=http://www.w3.org/2000/svg><path d="M3 4H21V6H3V4ZM3 11H15V13H3V11ZM3 18H21V20H3V18Z" fill=currentColor></path></svg></button></div></div></header><div id=post-wrapper><div id=blank></div><main><div id=top></div><article><h1>How to upgrade the Kernel (beginner)</h1><div id=post-info><div id=date><span id=publish>2021-10-16</span></div><div id=tags><a href=https://dariofad.github.io//tags/beginner># beginner</a><a href=https://dariofad.github.io//tags/linux># linux</a><a href=https://dariofad.github.io//tags/kernel># kernel</a><a href=https://dariofad.github.io//tags/build># build</a><a href=https://dariofad.github.io//tags/landlock># landlock</a></div></div><p>In this post I'll show you how to build and install the latest Kernel version available to your system, possibly enabling the Landlock LSM module.</p><span id=continue-reading></span><p>One of the latest modules available in the Linux Kernel is Landlock, an unprivileged sandboxing mechanism that allows a process to confine itself. Since it could be useful for one of my new projects, I decided to try it out. Landlock was merged into <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/commit/?id=17ae69aba89d" rel="nofollow noreferrer">Linux 5.13</a>. As I wanted to test the latest version available, I needed a <strong>Kernel upgrade</strong>. Contrary to what one might think, upgrading the Kernel with a more recent version is really easy.<p>In this post I'll show you how to <strong>build and install</strong> the latest <strong>Kernel</strong> version available to your system, possibly enabling the Landlock LSM module.<h2 id=upgrade>Upgrade<a aria-label="Anchor link for: upgrade" class=zola-anchor href=#upgrade>#</a></h2><p>Before we begin, I'd like to remind you that we're not installing the latest Kernel image via <code>apt</code> from the official repository of your distribution, but from source files. Thus, I recommend installing a VM, with at least 50 GB of dedicated storage (after the build, the local folder containing the latest image occupies approximately 21 GB). The following procedure has been tested with Ubuntu 21.10.<h2 id=source-files-requirements>Source files, requirements<a aria-label="Anchor link for: source-files-requirements" class=zola-anchor href=#source-files-requirements>#</a></h2><p>The first thing to do is to download the Kernel mainline version. You can either do this from <a rel="nofollow noreferrer" href=https://www.kernel.org/>The Linux Kernel Archives</a> or from <a rel="nofollow noreferrer" href=https://github.com/torvalds/linux>Github</a>. From terminal you run:<pre class=language-bash data-lang=bash style=color:#6c7079;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#eb6772>wget</span><span style=color:#abb2bf> https://cdn.kernel.org/pub/linux/kernel/v5.x/linux-5.15-rc5.tar.xz
</span><span style=color:#eb6772>tar -xvf</span><span style=color:#abb2bf> linux-5.15-rc5.tar.xz
</span><span style=color:#5ebfcc>cd</span><span style=color:#abb2bf> linux-5.15-rc5
</span></code></pre><p>To compile the kernel you need a minimal set of <a rel="nofollow noreferrer" href=https://www.kernel.org/doc/html/v4.13/process/changes.html>requirements</a>. The version of each tool may vary between different platforms (based on the architecture), in my case I just need the following:<pre class=language-bash data-lang=bash style=color:#6c7079;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#eb6772>sudo</span><span style=color:#abb2bf> apt install \
</span><span style=color:#abb2bf>	fakeroot \</span><span style=color:#fff;background-color:#e05252> </span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>	</span><span style=color:#eb6772>build-essential </span><span style=color:#abb2bf>\
</span><span style=color:#abb2bf>	ncurses-doc \
</span><span style=color:#abb2bf>	libncurses-dev \
</span><span style=color:#abb2bf>	xz-utils \
</span><span style=color:#abb2bf>	libssl-dev \
</span><span style=color:#abb2bf>	bc \
</span><span style=color:#abb2bf>	flex \
</span><span style=color:#abb2bf>	libelf-dev \
</span><span style=color:#abb2bf>	bison
</span></code></pre><h2 id=edit-the-build-configuration>Edit the build configuration<a aria-label="Anchor link for: edit-the-build-configuration" class=zola-anchor href=#edit-the-build-configuration>#</a></h2><p>To configure the build we need to edit the content of the <code>.config</code> configuration file. This is an automatically generated file that should be changed only with the terminal-oriented <code>menuconfig</code> configuration tool (you can start it running <code>make menuconfig</code>). However, since we already have a valid configuration for our VM saved at <code>/boot/config-$(uname -r)</code>, we can override <code>.config</code> with its content. To do that run:<pre class=language-bash data-lang=bash style=color:#6c7079;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#eb6772>cp</span><span style=color:#abb2bf> /boot/config-$(</span><span style=color:#eb6772>uname -r</span><span style=color:#abb2bf>) .config
</span></code></pre><p>Notice that when you override <code>.config</code>, you're deleting the configuration required by the components or modules that were added to the Kernel repository after your running Kernel image was created. This typically impacts he drivers added to support new hardware. Anyway, it isn't a big problem: you can either use <code>menuconfig</code> to specify the missing bits, or directly provide the input at build time (from terminal, according to the default options).<p>Additionally, as we won't need to seal keys in a TPM using <a rel="nofollow noreferrer" href=https://man7.org/linux/man-pages/man7/keyrings.7.html>keyrings</a>, we can edit <code>.config</code> setting the variable <code>CONFIG_SYSTEM_TRUSTED_KEYS</code> to <code>""</code>. Also, we can comment out the line <code>CONFIG_DEBUG_INFO_BTF=y</code>, as we won't need to debug eBPF programs.<p>Finally, if you want to activate Landlock LSM, edit the security options setting the <code>CONFIG_LSM</code> variable to:<pre class=language-make data-lang=make style=color:#6c7079;background-color:#2b303b><code class=language-make data-lang=make><span style=color:#eb6772>CONFIG_LSM</span><span style=color:#adb7c9>=</span><span style=color:#9acc76>"lockdown,yama,integrity,apparmor,landlock"
</span></code></pre><h2 id=compile-and-install>Compile and install<a aria-label="Anchor link for: compile-and-install" class=zola-anchor href=#compile-and-install>#</a></h2><p>We're now ready to compile the Kernel. Run:<pre class=language-bash data-lang=bash style=color:#6c7079;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#eb6772>make -jN
</span></code></pre><p>where N is the number of jobs allowed at once. Kernel compilation takes a while. Once the process terminates, you can install the modules to <code>/lib/modules/linux-5.15-rc5</code> running:<pre class=language-bash data-lang=bash style=color:#6c7079;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#eb6772>sudo</span><span style=color:#abb2bf> make modules_install
</span></code></pre><p>and the save the Kernel executable bzImage to <code>/boot/vmlinuz</code> running:<pre class=language-bash data-lang=bash style=color:#6c7079;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#eb6772>sudo</span><span style=color:#abb2bf> make install
</span></code></pre><p>Notice that, by performing the last operation, you don't need to manually execute <code>update-initramfs</code> and update Grub with the new option. Indeed, you can verify that the new Kernel is the first boot option reading the content of <code>/boot/grub/grub.cfg</code>. Don't worry, you don't need to understand the syntax of this file, you can just search for the keyword <code>menuentry</code> (the main menu) with the following Awk one-liner:<pre class=language-bash data-lang=bash style=color:#6c7079;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#eb6772>sudo</span><span style=color:#abb2bf> awk</span><span style=color:#eb6772> -F</span><span style=color:#5ebfcc>\' </span><span style=color:#9acc76>'/menuentry / {print $2}'</span><span style=color:#abb2bf> /boot/grub/grub.cfg
</span></code></pre><p>The program prints the chars following the string <code>menuentry '</code>, until the terminator <code>'</code>(as specified by the field separator argument <code>-F</code>) is found, for each occurence of the keyword.<h2 id=check-the-lsm-is-working>Check the LSM is working<a aria-label="Anchor link for: check-the-lsm-is-working" class=zola-anchor href=#check-the-lsm-is-working>#</a></h2><p>To boot into the new Kernel we only need to restart the VM. After that, you can open the terminal and verify that Landlock is running:<p align=center><img src=landlock_status.png width=700></article><footer><div class=copyright><p>© 2023 Dario Facchinetti</div></footer></main><aside class=blur><nav><ul><li><a href=#upgrade>Upgrade</a><li><a href=#source-files-requirements>Source files, requirements</a><li><a href=#edit-the-build-configuration>Edit the build configuration</a><li><a href=#compile-and-install>Compile and install</a><li><a href=#check-the-lsm-is-working>Check the LSM is working</a></ul></nav></aside></div><script src=/js/lightense.min.js></script><script src=/js/main.js></script>