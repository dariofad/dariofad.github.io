<!doctype html><html lang=en><head><meta charset=utf-8><meta content="width=device-width,initial-scale=1.0" name=viewport><meta content="light dark" name=color-scheme><title>Calling Go from Python via gRPC</title><meta content="<p>In this post I’ll show you how to make remote procedure calls via gRPC
between Python and Go, securing the communication with TLS.</p>" name=description><link href=/img/favicon-32x32.png rel=icon sizes=32x32 type=image/png><link href=/img/favicon-16x16.png rel=icon sizes=16x16 type=image/png><link href=/img/apple-touch-icon.png rel=apple-touch-icon sizes=180x180><link href=https://fonts.googleapis.com rel=preconnect><link crossorigin href=https://fonts.gstatic.com rel=preconnect><link href="https://fonts.googleapis.com/css2?family=Roboto&display=swap" rel=stylesheet><link href=/main.css rel=stylesheet><body class=post><script>if (localStorage.getItem('theme') == 'dark') document.body.classList.add('dark');</script><header class=blur><div id=wrapper><nav><a href=/>Home</a><span class=separator>></span><a href=https://dariofad.github.io/blog/>blog</a></nav><div id=btns><button aria-label="theme switch" data-moon-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M10 7C10 10.866 13.134 14 17 14C18.9584 14 20.729 13.1957 21.9995 11.8995C22 11.933 22 11.9665 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C12.0335 2 12.067 2 12.1005 2.00049C10.8043 3.27098 10 5.04157 10 7ZM4 12C4 16.4183 7.58172 20 12 20C15.0583 20 17.7158 18.2839 19.062 15.7621C18.3945 15.9187 17.7035 16 17 16C12.0294 16 8 11.9706 8 7C8 6.29648 8.08133 5.60547 8.2379 4.938C5.71611 6.28423 4 8.9417 4 12Z" fill="currentColor"></path></svg>' data-sun-icon='<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M12 18C8.68629 18 6 15.3137 6 12C6 8.68629 8.68629 6 12 6C15.3137 6 18 8.68629 18 12C18 15.3137 15.3137 18 12 18ZM12 16C14.2091 16 16 14.2091 16 12C16 9.79086 14.2091 8 12 8C9.79086 8 8 9.79086 8 12C8 14.2091 9.79086 16 12 16ZM11 1H13V4H11V1ZM11 20H13V23H11V20ZM3.51472 4.92893L4.92893 3.51472L7.05025 5.63604L5.63604 7.05025L3.51472 4.92893ZM16.9497 18.364L18.364 16.9497L20.4853 19.0711L19.0711 20.4853L16.9497 18.364ZM19.0711 3.51472L20.4853 4.92893L18.364 7.05025L16.9497 5.63604L19.0711 3.51472ZM5.63604 16.9497L7.05025 18.364L4.92893 20.4853L3.51472 19.0711L5.63604 16.9497ZM23 11V13H20V11H23ZM4 11V13H1V11H4Z" fill="currentColor"></path></svg>' id=theme-toggle><svg viewbox="0 0 24 24" height=24 width=24 xmlns=http://www.w3.org/2000/svg><path d="M10 7C10 10.866 13.134 14 17 14C18.9584 14 20.729 13.1957 21.9995 11.8995C22 11.933 22 11.9665 22 12C22 17.5228 17.5228 22 12 22C6.47715 22 2 17.5228 2 12C2 6.47715 6.47715 2 12 2C12.0335 2 12.067 2 12.1005 2.00049C10.8043 3.27098 10 5.04157 10 7ZM4 12C4 16.4183 7.58172 20 12 20C15.0583 20 17.7158 18.2839 19.062 15.7621C18.3945 15.9187 17.7035 16 17 16C12.0294 16 8 11.9706 8 7C8 6.29648 8.08133 5.60547 8.2379 4.938C5.71611 6.28423 4 8.9417 4 12Z" fill=currentColor></path></svg></button><button aria-label="table of content" id=toc-toggle><svg viewbox="0 0 24 24" height=24 width=24 xmlns=http://www.w3.org/2000/svg><path d="M3 4H21V6H3V4ZM3 11H15V13H3V11ZM3 18H21V20H3V18Z" fill=currentColor></path></svg></button></div></div></header><div id=post-wrapper><div id=blank></div><main><div id=top></div><article><h1>Calling Go from Python via gRPC</h1><div id=post-info><div id=date><span id=publish>2022-05-20</span></div><div id=tags><a href=https://dariofad.github.io//tags/grpc># grpc</a><a href=https://dariofad.github.io//tags/go># go</a><a href=https://dariofad.github.io//tags/python># python</a><a href=https://dariofad.github.io//tags/stream># stream</a><a href=https://dariofad.github.io//tags/tls># tls</a></div></div><p>In this post I’ll show you how to make remote procedure calls via gRPC between Python and Go, securing the communication with TLS.</p><span id=continue-reading></span><p>A common problem for developers is the invocation of code running in separate contexts. To give some examples, the developer may connect to a service to download a file, retrieve the inbox mail, get its feed and many more. A modern framework to connect services in and across data centers is <a rel="nofollow noreferrer" href=https://grpc.io/>gRPC</a>. In this post I'll show you how to make <strong>remote procedure calls</strong> via <strong>gRPC</strong> between Python and Go. I'll also share some tips to provide end-to-end security of data transmitted.<h2 id=what-is-grpc>What is gRPC<a aria-label="Anchor link for: what-is-grpc" class=zola-anchor href=#what-is-grpc>#</a></h2><p>As mentioned before, gRPC is a high performance remote procedure call framework. gRPC is based on the idea of defining a service. The service specifies a set of methods that can be called remotely, along with their type parameters. The service interface is implemented and exposed by a server. A client can talk to the server simply by calling one of the methods defined in the interface.<div style=width:100%;max-width:600px;margin-left:auto;margin-right:auto><img src=client-stub.png></div><p>What makes gRPC special is that the client can invoke the functions exposed by the server simply by calling them, as if they were locally defined. Moreover, since the service interface is language agnostic, there is no need to worry about the interoperability between the languages used to implement the client or the server (contrary to what happens with Foreign Function Interfaces FFIs). Indeed, client and server do not communicate sharing raw memory directly, but with <em>messages</em>. To structure them gRPC relies on <a rel="nofollow noreferrer" href=https://developers.google.com/protocol-buffers/docs/overview>Protocol Buffers</a>, an open source mechanism for serializing structured data.<h2 id=the-project>The project<a aria-label="Anchor link for: the-project" class=zola-anchor href=#the-project>#</a></h2><p>To illustrate how gRPC works I'll use a basic example. Imagine you have a web mapping platform like Google Maps, you may have some satellites scanning the Earth and storing the data on a server, and clients performing some queries to the server to get the view of a location. For simplicity, assume you already have a 80x32 (width, height) 2D map of the Earth stored on the server. The goal is to support queries to get the image associated with the <code>xy</code> coordinate of a location, and also queries to get the view associated with a broader rectangular area delimited by the <code>xy</code> coordinates associated with its bottom-left and top-right corners. Also, you may want to encrypt the communication between client and server to counter eavesdropping and ensure no third-parties are able to perform MITM attacks (i.e., like replacing the image associated with a coordinate).<p>In the following sections we'll go through the implementation step-by-step. The source code is available <a rel="nofollow noreferrer" href=https://github.com/dariofad/grpc_py_go_example>here</a>.<h2 id=service-interface>Service interface<a aria-label="Anchor link for: service-interface" class=zola-anchor href=#service-interface>#</a></h2><p>The first step when working with protocol buffers is to define the structure for the data that will be shared between client and server, or the <em>messages</em>. These structures are defined in a proto file, which is simply a text file with a <code>.proto</code> extension. Each message can be seen as a struct, and the important thing to understand is that the <em>fields</em> in each message have fixed type and pre-defined ordering. Let's see what messages look like in our <code>satellite.proto</code> file.<pre style=color:#6c7079;background-color:#2b303b><code><span style=color:#abb2bf>syntax = "proto3";
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>message Location {
</span><span style=color:#abb2bf>	int32 x = 1;
</span><span style=color:#abb2bf>	int32 y = 2;	
</span><span style=color:#abb2bf>}
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>message Area {
</span><span style=color:#abb2bf>	Location ll = 1;
</span><span style=color:#abb2bf>	Location ur = 2;	
</span><span style=color:#abb2bf>}
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>message Image {
</span><span style=color:#abb2bf>	int32 x = 1;
</span><span style=color:#abb2bf>	int32 y = 2;
</span><span style=color:#abb2bf>	bytes img = 3;
</span><span style=color:#abb2bf>}
</span></code></pre><p>As we can see from the code, the <code>Location</code> message uses only <strong>scalar types</strong>, the <code>x</code> and <code>y</code> coordinates. To each scalar type, Protocol buffers enable the serialization (without loss of information) to a programming language target type (see <a rel="nofollow noreferrer" href=https://developers.google.com/protocol-buffers/docs/proto3#scalar>here</a> for the complete reference). Messages can also be used as fields in other messages, as can be seen in <code>Area</code>. This is called <em>nested</em> messages. With regard to the <code>Image</code> message, I opted for using simply <code>bytes</code>.<p>Now that we have defined the messages, we need to define the services. This can be done directly in the proto file used for the definition of messages. In our case we're going to have a single service <code>Satellite</code>. The service is going to expose two RPCs: <code>GetImage</code> to return a single image, and <code>GetImages</code> to return multiple images (for the rectangular area).<pre style=color:#6c7079;background-color:#2b303b><code><span style=color:#abb2bf>service Satellite {
</span><span style=color:#abb2bf>	rpc GetImage (Location) returns (Image) {};
</span><span style=color:#abb2bf>	rpc GetImages (Area) returns (stream Image) {};
</span><span style=color:#abb2bf>}
</span></code></pre><p><code>GetImage</code> is a unary RPC where the client sends a single request to the server and gets a response back (just like a normal function call), while <code>GetImages</code> is a server streaming RPC, where the client sends a single request to the server and gets a stream to read a sequence of messages back.<h2 id=server-stub-generation>Server, stub generation<a aria-label="Anchor link for: server-stub-generation" class=zola-anchor href=#server-stub-generation>#</a></h2><p>The next step to be performed is the automatic generation of the client stub and the gRPC server. To do this we first need to install the <code>protoc</code> compiler to serialize the messages (available <a rel="nofollow noreferrer" href=https://github.com/protocolbuffers/protobuf/>here</a>), the <code>protoc-gen-go-grpc</code> tool to generate the Go bindings to our service for the server (available <a rel="nofollow noreferrer" href=https://pkg.go.dev/google.golang.org/grpc/cmd/protoc-gen-go-grpc#section-readme>here</a>), and <code>grpcio</code>, <code>grpcio-tools</code>, and <code>protobuf</code> packages to generate the bindings to our service for the Python client (the Makefile in the project provides a recipe to automatically download and install the dependencies). It is important to separate in different directories the code associated with the service interface, the server, and the client. The structure I'm using for the project is:<pre style=color:#6c7079;background-color:#2b303b><code><span style=color:#abb2bf>├── client
</span><span style=color:#abb2bf>│   ├── app.py
</span><span style=color:#abb2bf>├── protos
</span><span style=color:#abb2bf>│   └── satellite.proto
</span><span style=color:#abb2bf>├── server
</span><span style=color:#abb2bf>│   └── server.go
</span></code></pre><p>To generate the bindings we start from the server. We want to generate them inside <code>server/</code>, in a dedicated package. To do that, we add to the proto file (immediately after <code>syntax</code>) the lines:<pre style=color:#6c7079;background-color:#2b303b><code><span style=color:#abb2bf>package satellite;
</span><span style=color:#abb2bf>option go_package = "example.com/satellitepb";
</span></code></pre><p>and run:<pre class=language-bash data-lang=bash style=color:#6c7079;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#eb6772>protoc --go-grpc_out</span><span style=color:#adb7c9>=</span><span style=color:#abb2bf>server/</span><span style=color:#eb6772> --go_out</span><span style=color:#adb7c9>=</span><span style=color:#abb2bf>server/ protos/satellite.proto
</span></code></pre><p>from the command line. Then we generate the bindings for the client. The Python toolchain requires a slightly different configuration, in this case we are going to generate the bindings inside <code>client/protos/</code>. To do that we run:<p><code>python -m grpc_tools.protoc -I. --python_out=client --grpc_python_out=client protos/satellite.proto</code><p>As a result of the previous steps you should see the following files in the project directory:<pre style=color:#6c7079;background-color:#2b303b><code><span style=color:#abb2bf>├── client
</span><span style=color:#abb2bf>│   ├── protos
</span><span style=color:#abb2bf>│   │   ├── satellite_pb2_grpc.py
</span><span style=color:#abb2bf>│   │   └── satellite_pb2.py
</span><span style=color:#abb2bf>├── server
</span><span style=color:#abb2bf>│   ├── example.com
</span><span style=color:#abb2bf>│   │   └── satellitepb
</span><span style=color:#abb2bf>│   │       ├── satellite_grpc.pb.go
</span><span style=color:#abb2bf>│   │       └── satellite.pb.go
</span></code></pre><p>The generation of the service interface for the client and the server is complete.<h2 id=serving-single-requests>Serving single requests<a aria-label="Anchor link for: serving-single-requests" class=zola-anchor href=#serving-single-requests>#</a></h2><p>To serve single requests we first need to spawn a gRPC server on a dedicated port, then we have to provide an implementation of the <code>GetImage</code> service.<h3 id=server>Server<a aria-label="Anchor link for: server" class=zola-anchor href=#server>#</a></h3><p>In our case, the server stores the map along with two loggers, one to log information such as incoming requests, and the other to log errors. Please note that we also need to embed the automatically generated <code>satellitepb.UnimplementedSatelliteServer</code>. This is done to ensure forward compatible implementations (the inner type is used as a base class in an OOP language). At initialization time, we get an instance of the server and load the map from a template. We previously defined the map as a collection of images, each represented as a sequence of bytes. However, to demonstrate how gRPC works we can just replace each image by a single character (empty character for the sea, non empty character for land). Nothing changes from a technical perspective, but doing so allow us to print the map nicely to console.<pre class=language-go data-lang=go style=color:#6c7079;background-color:#2b303b><code class=language-go data-lang=go><span style=color:#cd74e8>var </span><span style=color:#abb2bf>(
</span><span style=color:#abb2bf>	</span><span style=color:#eb6772>height </span><span style=color:#cd74e8>int </span><span style=color:#adb7c9>= </span><span style=color:#db9d63>32
</span><span style=color:#abb2bf>	</span><span style=color:#eb6772>width  </span><span style=color:#cd74e8>int </span><span style=color:#adb7c9>= </span><span style=color:#db9d63>80
</span><span style=color:#abb2bf>)
</span><span style=color:#abb2bf>
</span><span style=color:#cd74e8>type </span><span style=color:#abb2bf>Server </span><span style=color:#cd74e8>struct </span><span style=color:#abb2bf>{
</span><span style=color:#abb2bf>	</span><span style=color:#eb6772>satellitepb</span><span style=color:#abb2bf>.</span><span style=color:#9acc76>UnimplementedSatelliteServer
</span><span style=color:#abb2bf>	</span><span style=color:#eb6772>InfoLog                                  </span><span style=color:#adb7c9>*</span><span style=color:#eb6772>log</span><span style=color:#abb2bf>.</span><span style=color:#cd74e8>Logger
</span><span style=color:#abb2bf>	</span><span style=color:#eb6772>ErrorLog                                 </span><span style=color:#adb7c9>*</span><span style=color:#eb6772>log</span><span style=color:#abb2bf>.</span><span style=color:#cd74e8>Logger
</span><span style=color:#abb2bf>	</span><span style=color:#eb6772>sMap                                     </span><span style=color:#abb2bf>[]</span><span style=color:#cd74e8>string
</span><span style=color:#abb2bf>}
</span><span style=color:#abb2bf>
</span><span style=color:#cd74e8>func </span><span style=color:#5cb3fa>NewServer</span><span style=color:#abb2bf>() </span><span style=color:#adb7c9>*</span><span style=color:#cd74e8>Server </span><span style=color:#abb2bf>{
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>	</span><span style=color:#eb6772>s </span><span style=color:#adb7c9>:= &</span><span style=color:#eb6772>Server</span><span style=color:#abb2bf>{}
</span><span style=color:#abb2bf>	</span><span style=color:#eb6772>s</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>InfoLog </span><span style=color:#adb7c9>= </span><span style=color:#eb6772>log</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>New</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>os</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>Stdout</span><span style=color:#abb2bf>, </span><span style=color:#9acc76>"INFO:</span><span style=color:#5ebfcc>\t</span><span style=color:#9acc76>"</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>log</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>Lmicroseconds</span><span style=color:#abb2bf>)
</span><span style=color:#abb2bf>	</span><span style=color:#eb6772>s</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>ErrorLog </span><span style=color:#adb7c9>= </span><span style=color:#eb6772>log</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>New</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>os</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>Stdout</span><span style=color:#abb2bf>, </span><span style=color:#9acc76>"ERROR:</span><span style=color:#5ebfcc>\t</span><span style=color:#9acc76>"</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>log</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>Lmicroseconds</span><span style=color:#abb2bf>)
</span><span style=color:#abb2bf>	</span><span style=color:#eb6772>s</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>sMap </span><span style=color:#adb7c9>= </span><span style=color:#5ebfcc>make</span><span style=color:#abb2bf>([]</span><span style=color:#cd74e8>string</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>height</span><span style=color:#abb2bf>)
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>	</span><span style=color:#cd74e8>return </span><span style=color:#eb6772>s
</span><span style=color:#abb2bf>}
</span><span style=color:#abb2bf>
</span><span style=color:#cd74e8>func </span><span style=color:#abb2bf>(</span><span style=color:#eb6772>s </span><span style=color:#adb7c9>*</span><span style=color:#cd74e8>Server</span><span style=color:#abb2bf>) </span><span style=color:#5cb3fa>LoadMap</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>fname </span><span style=color:#cd74e8>string</span><span style=color:#abb2bf>) {
</span><span style=color:#abb2bf>	</span><span style=color:#adb7c9>...
</span><span style=color:#abb2bf>}
</span><span style=color:#abb2bf>
</span><span style=color:#cd74e8>func </span><span style=color:#5cb3fa>main</span><span style=color:#abb2bf>() {
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>	</span><span style=color:#5f697a;font-style:italic>// load the example map
</span><span style=color:#abb2bf>	</span><span style=color:#eb6772>s </span><span style=color:#adb7c9>:= </span><span style=color:#eb6772>NewServer</span><span style=color:#abb2bf>()
</span><span style=color:#abb2bf>	</span><span style=color:#eb6772>s</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>LoadMap</span><span style=color:#abb2bf>(</span><span style=color:#9acc76>"map.txt"</span><span style=color:#abb2bf>)
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>	</span><span style=color:#5f697a;font-style:italic>// create a tcp listener
</span><span style=color:#abb2bf>	</span><span style=color:#eb6772>lis</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>err </span><span style=color:#adb7c9>:= </span><span style=color:#eb6772>net</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>Listen</span><span style=color:#abb2bf>(</span><span style=color:#9acc76>"tcp"</span><span style=color:#abb2bf>, </span><span style=color:#9acc76>"0.0.0.0:8000"</span><span style=color:#abb2bf>)
</span><span style=color:#abb2bf>	</span><span style=color:#cd74e8>if </span><span style=color:#eb6772>err </span><span style=color:#adb7c9>!= </span><span style=color:#db9d63>nil </span><span style=color:#abb2bf>{
</span><span style=color:#abb2bf>		</span><span style=color:#eb6772>log</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>Fatalf</span><span style=color:#abb2bf>(</span><span style=color:#9acc76>"Cannot listen to 0.0.0.0:8000 </span><span style=color:#db9d63>%v</span><span style=color:#9acc76>"</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>err</span><span style=color:#abb2bf>)
</span><span style=color:#abb2bf>	}
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>	</span><span style=color:#5f697a;font-style:italic>// init the gRPC server
</span><span style=color:#abb2bf>	</span><span style=color:#eb6772>grpcServer </span><span style=color:#adb7c9>:= </span><span style=color:#eb6772>grpc</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>NewServer</span><span style=color:#abb2bf>()
</span><span style=color:#abb2bf>	</span><span style=color:#eb6772>satellitepb</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>RegisterSatelliteServer</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>grpcServer</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>s</span><span style=color:#abb2bf>)
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>	</span><span style=color:#5f697a;font-style:italic>// serve requests
</span><span style=color:#abb2bf>	</span><span style=color:#eb6772>log</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>Println</span><span style=color:#abb2bf>(</span><span style=color:#9acc76>"Server starting..."</span><span style=color:#abb2bf>)
</span><span style=color:#abb2bf>	</span><span style=color:#eb6772>log</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>Fatal</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>grpcServer</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>Serve</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>lis</span><span style=color:#abb2bf>))
</span><span style=color:#abb2bf>}
</span><span style=color:#abb2bf>
</span></code></pre><p>After loading the map we start a tcp listener on port 8000, and instantiate the default gRPC server. The default gRPC server has no service registered and has not started to accept requests yet. The skeleton of the server is implemented in the <code>google.golang.org/grpc</code> package. We register our <code>Server</code> to it using the bindings generated with <code>protoc-gen-go-grpc</code>. After that, we can serve incoming requests on port 8000. The skeleton implementation of the server provides the logic to accept incoming connections on the listener <code>lis</code>. Each service request will be handled in a dedicated goroutine, and served invoking the proper handle.<p>To effectively serve <code>GetImage</code> requests we have to provide an implementation of the related handle (if you remember we have embedded in our <code>Server</code> struct the type <code>satellitepb.UnimplementedSatelliteServer</code>). The prototype of the handler is again defined in <code>satellite_grpc.pb.go</code>, we just need to add the body as shown below.<pre class=language-go data-lang=go style=color:#6c7079;background-color:#2b303b><code class=language-go data-lang=go><span style=color:#cd74e8>func </span><span style=color:#abb2bf>(</span><span style=color:#eb6772>s </span><span style=color:#adb7c9>*</span><span style=color:#cd74e8>Server</span><span style=color:#abb2bf>) </span><span style=color:#5cb3fa>GetImage</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>ctx context</span><span style=color:#abb2bf>.</span><span style=color:#cd74e8>Context</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>loc </span><span style=color:#adb7c9>*</span><span style=color:#eb6772>satellitepb</span><span style=color:#abb2bf>.</span><span style=color:#cd74e8>Location</span><span style=color:#abb2bf>) (</span><span style=color:#adb7c9>*</span><span style=color:#eb6772>satellitepb</span><span style=color:#abb2bf>.</span><span style=color:#cd74e8>Image</span><span style=color:#abb2bf>, </span><span style=color:#cd74e8>error</span><span style=color:#abb2bf>) {
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>	</span><span style=color:#eb6772>s</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>InfoLog</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>Printf</span><span style=color:#abb2bf>(</span><span style=color:#9acc76>"GetImage request (x: </span><span style=color:#db9d63>%d</span><span style=color:#9acc76>, y: </span><span style=color:#db9d63>%d</span><span style=color:#9acc76>)</span><span style=color:#5ebfcc>\n</span><span style=color:#9acc76>"</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>loc</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>X</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>loc</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>Y</span><span style=color:#abb2bf>)
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>	</span><span style=color:#eb6772>isValidCoord </span><span style=color:#adb7c9>:= </span><span style=color:#eb6772>s</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>CheckLocation</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>loc</span><span style=color:#abb2bf>)
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>	</span><span style=color:#cd74e8>if </span><span style=color:#adb7c9>!</span><span style=color:#eb6772>isValidCoord </span><span style=color:#abb2bf>{
</span><span style=color:#abb2bf>		</span><span style=color:#cd74e8>return </span><span style=color:#db9d63>nil</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>status</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>Errorf</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>codes</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>OutOfRange</span><span style=color:#abb2bf>,
</span><span style=color:#abb2bf>			</span><span style=color:#eb6772>OutOfBoundFmt</span><span style=color:#abb2bf>,
</span><span style=color:#abb2bf>			</span><span style=color:#eb6772>loc</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>X</span><span style=color:#abb2bf>,
</span><span style=color:#abb2bf>			</span><span style=color:#eb6772>loc</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>Y</span><span style=color:#abb2bf>)
</span><span style=color:#abb2bf>	}
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>	</span><span style=color:#eb6772>h </span><span style=color:#adb7c9>:= </span><span style=color:#eb6772>loc</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>Y
</span><span style=color:#abb2bf>	</span><span style=color:#eb6772>w </span><span style=color:#adb7c9>:= </span><span style=color:#eb6772>loc</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>X
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>	</span><span style=color:#eb6772>img </span><span style=color:#adb7c9>:= &</span><span style=color:#eb6772>satellitepb</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>Image</span><span style=color:#abb2bf>{
</span><span style=color:#abb2bf>		</span><span style=color:#eb6772>Y</span><span style=color:#abb2bf>:   </span><span style=color:#eb6772>int32</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>h</span><span style=color:#abb2bf>),
</span><span style=color:#abb2bf>		</span><span style=color:#eb6772>X</span><span style=color:#abb2bf>:   </span><span style=color:#eb6772>int32</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>w</span><span style=color:#abb2bf>),
</span><span style=color:#abb2bf>		</span><span style=color:#eb6772>Img</span><span style=color:#abb2bf>: []</span><span style=color:#cd74e8>byte</span><span style=color:#abb2bf>{</span><span style=color:#eb6772>s</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>sMap</span><span style=color:#abb2bf>[</span><span style=color:#eb6772>h</span><span style=color:#abb2bf>][</span><span style=color:#eb6772>w</span><span style=color:#adb7c9>+</span><span style=color:#db9d63>1</span><span style=color:#abb2bf>]},
</span><span style=color:#abb2bf>	}
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>	</span><span style=color:#cd74e8>return </span><span style=color:#eb6772>img</span><span style=color:#abb2bf>, </span><span style=color:#db9d63>nil
</span><span style=color:#abb2bf>}
</span></code></pre><p>The fuction receives as arguments a context <code>ctx</code> (which can be used to attach metadata and specify deadlines) and a <code>Location</code> message, and returns an <code>Image</code> as defined in the proto interface. Upon receiving a request, the server writes a record to the log, validates the coordinate, retrieves an image from the map, and then uses the proto interface to return it to the caller.<h3 id=client>Client<a aria-label="Anchor link for: client" class=zola-anchor href=#client>#</a></h3><p>The client must be able to open a channel to the server, send requests using the stub, and wait for the result. The procedure here is straightforward: 1) we use the <code>grpc.aio.insecure_channel()</code> method to create a channel to the server (specifying host and port), 2) instantiate the client stub using the bindings <code>satellite_pb2_grpc.py</code> generated with protoc, and 3) send the requests one at a time using the method <code>GetImage()</code> implemented by the auto-generated stub. Since requests are asynchronous operations, an Event Loop is used to run until the future (i.e., each request) has completed. The code is shown below.<pre class=language-python data-lang=python style=color:#6c7079;background-color:#2b303b><code class=language-python data-lang=python><span style=color:#abb2bf>server </span><span style=color:#adb7c9>= </span><span style=color:#9acc76>'0.0.0.0:8000'
</span><span style=color:#abb2bf>proxy </span><span style=color:#adb7c9>= </span><span style=color:#eb6772>SimpleProxy</span><span style=color:#abb2bf>(server)
</span><span style=color:#abb2bf>locations </span><span style=color:#adb7c9>= </span><span style=color:#abb2bf>{(</span><span style=color:#db9d63>1</span><span style=color:#abb2bf>,</span><span style=color:#db9d63>2</span><span style=color:#abb2bf>), (</span><span style=color:#db9d63>30</span><span style=color:#abb2bf>,</span><span style=color:#db9d63>25</span><span style=color:#abb2bf>), (</span><span style=color:#db9d63>50</span><span style=color:#abb2bf>,</span><span style=color:#db9d63>4</span><span style=color:#abb2bf>), (</span><span style=color:#db9d63>0</span><span style=color:#abb2bf>,</span><span style=color:#db9d63>0</span><span style=color:#abb2bf>), (</span><span style=color:#db9d63>50</span><span style=color:#abb2bf>,</span><span style=color:#db9d63>16</span><span style=color:#abb2bf>), (</span><span style=color:#db9d63>10</span><span style=color:#abb2bf>, </span><span style=color:#db9d63>1</span><span style=color:#abb2bf>)}
</span><span style=color:#abb2bf>result </span><span style=color:#adb7c9>= </span><span style=color:#abb2bf>proxy.</span><span style=color:#eb6772>GetRequests</span><span style=color:#abb2bf>(locations)
</span><span style=color:#abb2bf>
</span><span style=color:#cd74e8>class </span><span style=color:#f0c678>SimpleProxy</span><span style=color:#adb7c9>:
</span><span style=color:#abb2bf>    
</span><span style=color:#abb2bf>    </span><span style=color:#cd74e8>def </span><span style=color:#5ebfcc>__init__</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>self</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>server</span><span style=color:#abb2bf>):
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>        </span><span style=color:#eb6772>self</span><span style=color:#abb2bf>.server </span><span style=color:#adb7c9>= </span><span style=color:#abb2bf>server
</span><span style=color:#abb2bf>        
</span><span style=color:#abb2bf>    </span><span style=color:#cd74e8>def </span><span style=color:#5cb3fa>GetRequests</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>self</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>locations</span><span style=color:#abb2bf>):
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>        </span><span style=color:#5f697a;font-style:italic># Get single locations
</span><span style=color:#abb2bf>        </span><span style=color:#5ebfcc>print</span><span style=color:#abb2bf>(</span><span style=color:#9acc76>"[*] gRPC single requests:"</span><span style=color:#abb2bf>)
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>        </span><span style=color:#cd74e8>return </span><span style=color:#abb2bf>asyncio.</span><span style=color:#eb6772>get_event_loop</span><span style=color:#abb2bf>().</span><span style=color:#eb6772>run_until_complete</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>self</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>_getRequests</span><span style=color:#abb2bf>(locations))
</span><span style=color:#abb2bf>    
</span><span style=color:#abb2bf>    </span><span style=color:#cd74e8>async def </span><span style=color:#5cb3fa>_getRequests</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>self</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>locations</span><span style=color:#abb2bf>):
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>        result </span><span style=color:#adb7c9>= </span><span style=color:#abb2bf>[]
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>        </span><span style=color:#cd74e8>async with </span><span style=color:#abb2bf>grpc.aio.</span><span style=color:#eb6772>insecure_channel</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>self</span><span style=color:#abb2bf>.server) </span><span style=color:#cd74e8>as </span><span style=color:#abb2bf>channel:
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>            </span><span style=color:#5f697a;font-style:italic># Init the client stub
</span><span style=color:#abb2bf>            stub </span><span style=color:#adb7c9>= </span><span style=color:#abb2bf>protos.satellite_pb2_grpc.</span><span style=color:#eb6772>SatelliteStub</span><span style=color:#abb2bf>(channel)
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>            </span><span style=color:#cd74e8>for </span><span style=color:#abb2bf>loc </span><span style=color:#cd74e8>in </span><span style=color:#abb2bf>locations:
</span><span style=color:#abb2bf>                </span><span style=color:#cd74e8>try</span><span style=color:#abb2bf>:
</span><span style=color:#abb2bf>                    response </span><span style=color:#adb7c9>= </span><span style=color:#cd74e8>await </span><span style=color:#eb6772>self</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>_get_img</span><span style=color:#abb2bf>(stub, loc)
</span><span style=color:#abb2bf>                    result.</span><span style=color:#eb6772>append</span><span style=color:#abb2bf>((loc[</span><span style=color:#db9d63>0</span><span style=color:#abb2bf>], loc[</span><span style=color:#db9d63>1</span><span style=color:#abb2bf>], response.img))
</span><span style=color:#abb2bf>                </span><span style=color:#cd74e8>except </span><span style=color:#abb2bf>grpc.RpcError </span><span style=color:#cd74e8>as </span><span style=color:#abb2bf>e:
</span><span style=color:#abb2bf>                    status_code </span><span style=color:#adb7c9>= </span><span style=color:#abb2bf>e.</span><span style=color:#eb6772>code</span><span style=color:#abb2bf>()
</span><span style=color:#abb2bf>                    </span><span style=color:#cd74e8>if </span><span style=color:#abb2bf>grpc.StatusCode.</span><span style=color:#eb6772>OUT_OF_RANGE </span><span style=color:#adb7c9>== </span><span style=color:#abb2bf>status_code:
</span><span style=color:#abb2bf>                        </span><span style=color:#5ebfcc>print</span><span style=color:#abb2bf>(</span><span style=color:#9acc76>"Bad request, out of bound location"</span><span style=color:#abb2bf>, loc)
</span><span style=color:#abb2bf>                    </span><span style=color:#cd74e8>else</span><span style=color:#abb2bf>:
</span><span style=color:#abb2bf>                        </span><span style=color:#5ebfcc>print</span><span style=color:#abb2bf>(e)
</span><span style=color:#abb2bf>        </span><span style=color:#cd74e8>return </span><span style=color:#abb2bf>result
</span><span style=color:#abb2bf>        
</span><span style=color:#abb2bf>    </span><span style=color:#cd74e8>def </span><span style=color:#5cb3fa>_get_img</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>self</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>stub</span><span style=color:#abb2bf>: protos.satellite_pb2_grpc.SatelliteStub, </span><span style=color:#eb6772>location</span><span style=color:#abb2bf>):
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>        loc </span><span style=color:#adb7c9>= </span><span style=color:#abb2bf>protos.satellite_pb2.</span><span style=color:#eb6772>Location</span><span style=color:#abb2bf>()
</span><span style=color:#abb2bf>        loc.x </span><span style=color:#adb7c9>= </span><span style=color:#abb2bf>location[</span><span style=color:#db9d63>0</span><span style=color:#abb2bf>]
</span><span style=color:#abb2bf>        loc.y </span><span style=color:#adb7c9>= </span><span style=color:#abb2bf>location[</span><span style=color:#db9d63>1</span><span style=color:#abb2bf>]
</span><span style=color:#abb2bf>    
</span><span style=color:#abb2bf>        </span><span style=color:#5f697a;font-style:italic># send the request using the stub
</span><span style=color:#abb2bf>        </span><span style=color:#cd74e8>return </span><span style=color:#abb2bf>stub.</span><span style=color:#eb6772>GetImage</span><span style=color:#abb2bf>(loc)
</span></code></pre><h2 id=implementing-a-stream>Implementing a Stream<a aria-label="Anchor link for: implementing-a-stream" class=zola-anchor href=#implementing-a-stream>#</a></h2><h3 id=server-1>Server<a aria-label="Anchor link for: server-1" class=zola-anchor href=#server-1>#</a></h3><p>In the requirements we mentioned the ability to query the server to get a rectangular area of the map. Consider that, in a real scenario, maps can grow very large, and we want to avoid the client to block until a big area is fully downloaded. The idea is then to send to the client a stream of messages associated with each location in the requested area, enabling the client app to render each image to the UI as soon as it is available.<p>To do that, we need to implement the server's <code>GetImages()</code> interface. Starting from the prototype generated in the <code>satellite_grpc.pb.go</code> file, we create a function as shown below.<pre class=language-go data-lang=go style=color:#6c7079;background-color:#2b303b><code class=language-go data-lang=go><span style=color:#cd74e8>func </span><span style=color:#abb2bf>(</span><span style=color:#eb6772>s </span><span style=color:#adb7c9>*</span><span style=color:#cd74e8>Server</span><span style=color:#abb2bf>) </span><span style=color:#5cb3fa>GetImages</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>area </span><span style=color:#adb7c9>*</span><span style=color:#eb6772>satellitepb</span><span style=color:#abb2bf>.</span><span style=color:#cd74e8>Area</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>stream satellitepb</span><span style=color:#abb2bf>.</span><span style=color:#cd74e8>Satellite_GetImagesServer</span><span style=color:#abb2bf>) </span><span style=color:#cd74e8>error </span><span style=color:#abb2bf>{
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>	</span><span style=color:#eb6772>s</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>InfoLog</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>Printf</span><span style=color:#abb2bf>(
</span><span style=color:#abb2bf>		</span><span style=color:#9acc76>"GetImages stream request (x: </span><span style=color:#db9d63>%d</span><span style=color:#9acc76>, y: </span><span style=color:#db9d63>%d</span><span style=color:#9acc76>) -> (x: </span><span style=color:#db9d63>%d</span><span style=color:#9acc76>, y: </span><span style=color:#db9d63>%d</span><span style=color:#9acc76>)</span><span style=color:#5ebfcc>\n</span><span style=color:#9acc76>"</span><span style=color:#abb2bf>,
</span><span style=color:#abb2bf>		</span><span style=color:#eb6772>area</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>Ll</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>X</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>area</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>Ll</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>Y</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>area</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>Ur</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>X</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>area</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>Ur</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>Y</span><span style=color:#abb2bf>)
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>	</span><span style=color:#5f697a;font-style:italic>/* ...check valid area...*/
</span><span style=color:#abb2bf>	
</span><span style=color:#abb2bf>	</span><span style=color:#cd74e8>for </span><span style=color:#eb6772>j </span><span style=color:#adb7c9>:= </span><span style=color:#eb6772>int</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>area</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>Ur</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>Y </span><span style=color:#adb7c9>- </span><span style=color:#eb6772>area</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>Ll</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>Y</span><span style=color:#abb2bf>); </span><span style=color:#eb6772>j </span><span style=color:#adb7c9>> </span><span style=color:#db9d63>0</span><span style=color:#abb2bf>; </span><span style=color:#eb6772>j</span><span style=color:#adb7c9>-- </span><span style=color:#abb2bf>{
</span><span style=color:#abb2bf>		</span><span style=color:#cd74e8>for </span><span style=color:#eb6772>i </span><span style=color:#adb7c9>:= </span><span style=color:#db9d63>0</span><span style=color:#abb2bf>; </span><span style=color:#eb6772>i </span><span style=color:#adb7c9>< </span><span style=color:#eb6772>int</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>area</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>Ur</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>X</span><span style=color:#adb7c9>-</span><span style=color:#eb6772>area</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>Ll</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>X</span><span style=color:#abb2bf>); </span><span style=color:#eb6772>i</span><span style=color:#adb7c9>++ </span><span style=color:#abb2bf>{
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>			</span><span style=color:#eb6772>w </span><span style=color:#adb7c9>:= </span><span style=color:#eb6772>int</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>area</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>Ll</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>X</span><span style=color:#abb2bf>) </span><span style=color:#adb7c9>+ </span><span style=color:#eb6772>i
</span><span style=color:#abb2bf>			</span><span style=color:#eb6772>h </span><span style=color:#adb7c9>:= </span><span style=color:#eb6772>int</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>area</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>Ll</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>Y</span><span style=color:#abb2bf>) </span><span style=color:#adb7c9>+ </span><span style=color:#eb6772>j
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>			</span><span style=color:#eb6772>img </span><span style=color:#adb7c9>:= &</span><span style=color:#eb6772>satellitepb</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>Image</span><span style=color:#abb2bf>{
</span><span style=color:#abb2bf>				</span><span style=color:#eb6772>Y</span><span style=color:#abb2bf>:   </span><span style=color:#eb6772>int32</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>h</span><span style=color:#abb2bf>),
</span><span style=color:#abb2bf>				</span><span style=color:#eb6772>X</span><span style=color:#abb2bf>:   </span><span style=color:#eb6772>int32</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>w</span><span style=color:#abb2bf>),
</span><span style=color:#abb2bf>				</span><span style=color:#eb6772>Img</span><span style=color:#abb2bf>: []</span><span style=color:#cd74e8>byte</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>s</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>sMap</span><span style=color:#abb2bf>[</span><span style=color:#eb6772>h</span><span style=color:#abb2bf>][</span><span style=color:#eb6772>w </span><span style=color:#abb2bf>: </span><span style=color:#eb6772>w</span><span style=color:#adb7c9>+</span><span style=color:#db9d63>1</span><span style=color:#abb2bf>]),
</span><span style=color:#abb2bf>			}
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>			</span><span style=color:#cd74e8>if </span><span style=color:#eb6772>err </span><span style=color:#adb7c9>:= </span><span style=color:#eb6772>stream</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>Send</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>img</span><span style=color:#abb2bf>); </span><span style=color:#eb6772>err </span><span style=color:#adb7c9>!= </span><span style=color:#db9d63>nil </span><span style=color:#abb2bf>{
</span><span style=color:#abb2bf>				</span><span style=color:#cd74e8>return </span><span style=color:#eb6772>err
</span><span style=color:#abb2bf>			}
</span><span style=color:#abb2bf>		}
</span><span style=color:#abb2bf>	}
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>	</span><span style=color:#cd74e8>return </span><span style=color:#db9d63>nil
</span><span style=color:#abb2bf>}
</span></code></pre><p>The key point here is to send multiple messages back to the client using the <code>stream.Send()</code> function. gRPC does not wait until the message is received by the client. As a result, an untimely stream closure may result in lost messages.<h3 id=client-1>Client<a aria-label="Anchor link for: client-1" class=zola-anchor href=#client-1>#</a></h3><p>Client side, we need to provide a way to download the map (or part of it), and simultaneously render it to the console. The simplest way to do so is perhaps using two processes exchanging memory with a queue. In the first process we execute a modified version of the proxy (which is used to query the server), while in the second, we run the rendering process to update the local map and visualize it to the UI.<pre class=language-python data-lang=python style=color:#6c7079;background-color:#2b303b><code class=language-python data-lang=python><span style=color:#abb2bf>queue </span><span style=color:#adb7c9>= </span><span style=color:#eb6772>Queue</span><span style=color:#abb2bf>()
</span><span style=color:#abb2bf>area </span><span style=color:#adb7c9>= </span><span style=color:#abb2bf>[(</span><span style=color:#db9d63>0</span><span style=color:#abb2bf>,</span><span style=color:#db9d63>0</span><span style=color:#abb2bf>), (</span><span style=color:#db9d63>79</span><span style=color:#abb2bf>,</span><span style=color:#db9d63>31</span><span style=color:#abb2bf>)] </span><span style=color:#5f697a;font-style:italic># coordinates of the area to download
</span><span style=color:#abb2bf>
</span><span style=color:#cd74e8>def </span><span style=color:#5cb3fa>Query</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>proxy</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>queue</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>area</span><span style=color:#abb2bf>):
</span><span style=color:#abb2bf>    proxy.</span><span style=color:#eb6772>GetStream</span><span style=color:#abb2bf>(queue, area)
</span><span style=color:#abb2bf>    
</span><span style=color:#abb2bf>query </span><span style=color:#adb7c9>= </span><span style=color:#eb6772>Process</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>target</span><span style=color:#adb7c9>=</span><span style=color:#abb2bf>Query, </span><span style=color:#eb6772>args</span><span style=color:#adb7c9>=</span><span style=color:#abb2bf>(proxy, queue, area,))
</span><span style=color:#abb2bf>query.</span><span style=color:#eb6772>start</span><span style=color:#abb2bf>()
</span><span style=color:#abb2bf>
</span><span style=color:#5f697a;font-style:italic># rendering to console
</span><span style=color:#cd74e8>while </span><span style=color:#db9d63>True</span><span style=color:#abb2bf>:
</span><span style=color:#abb2bf>	</span><span style=color:#5ebfcc>map</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>Render</span><span style=color:#abb2bf>(</span><span style=color:#db9d63>...</span><span style=color:#abb2bf>)
</span></code></pre><p>Compared to the single requests case, we just need to wait until the server stream is closed, and put each image into the queue as soon as it is available.<pre class=language-python data-lang=python style=color:#6c7079;background-color:#2b303b><code class=language-python data-lang=python><span style=color:#cd74e8>async def </span><span style=color:#5cb3fa>_get_imgs</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>self</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>queue</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>stub</span><span style=color:#abb2bf>: protos.satellite_pb2_grpc.SatelliteStub, </span><span style=color:#eb6772>xy1</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>xy2</span><span style=color:#abb2bf>):
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>    ll </span><span style=color:#adb7c9>= </span><span style=color:#abb2bf>protos.satellite_pb2.</span><span style=color:#eb6772>Location</span><span style=color:#abb2bf>()
</span><span style=color:#abb2bf>    ll.x </span><span style=color:#adb7c9>= </span><span style=color:#abb2bf>xy1[</span><span style=color:#db9d63>0</span><span style=color:#abb2bf>]
</span><span style=color:#abb2bf>    ll.y </span><span style=color:#adb7c9>= </span><span style=color:#abb2bf>xy1[</span><span style=color:#db9d63>1</span><span style=color:#abb2bf>]
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>    ur </span><span style=color:#adb7c9>= </span><span style=color:#abb2bf>protos.satellite_pb2.</span><span style=color:#eb6772>Location</span><span style=color:#abb2bf>()
</span><span style=color:#abb2bf>    ur.x </span><span style=color:#adb7c9>= </span><span style=color:#abb2bf>xy2[</span><span style=color:#db9d63>0</span><span style=color:#abb2bf>]
</span><span style=color:#abb2bf>    ur.y </span><span style=color:#adb7c9>= </span><span style=color:#abb2bf>xy2[</span><span style=color:#db9d63>1</span><span style=color:#abb2bf>]
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>    area </span><span style=color:#adb7c9>= </span><span style=color:#abb2bf>protos.satellite_pb2.</span><span style=color:#eb6772>Area</span><span style=color:#abb2bf>()
</span><span style=color:#abb2bf>    area.ll.</span><span style=color:#eb6772>CopyFrom</span><span style=color:#abb2bf>(ll)
</span><span style=color:#abb2bf>    area.ur.</span><span style=color:#eb6772>CopyFrom</span><span style=color:#abb2bf>(ur)
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>    responses </span><span style=color:#adb7c9>= </span><span style=color:#abb2bf>stub.</span><span style=color:#eb6772>GetImages</span><span style=color:#abb2bf>(area)
</span><span style=color:#abb2bf>    </span><span style=color:#cd74e8>async for </span><span style=color:#abb2bf>response </span><span style=color:#cd74e8>in </span><span style=color:#abb2bf>responses:
</span><span style=color:#abb2bf>        queue.</span><span style=color:#eb6772>put</span><span style=color:#abb2bf>([response.x, response.y, response.img])
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>    queue.</span><span style=color:#eb6772>put</span><span style=color:#abb2bf>(</span><span style=color:#db9d63>None</span><span style=color:#abb2bf>)
</span></code></pre><p>Just for the sake of testing, the server implementation in the repository uses a <code>SLEEP_TIME</code> between calls to <code>stream.Send()</code> to simulate the delay introduced by larger images. A fixed sleep time of 1 or 2 ms is should be enough to demonstrate the approach. Larger sleep times (e.g., >15 ms) can be used to test the cancellation of a request (i.e., the client can set a deadline for the request to be served).<p>We're ready for a demo!<div style=width:100%;margin-left:auto;margin-right:auto><img alt src=/assets/blog_assets/2022_05_20/demo.gif style=border-radius:1%></div><h2 id=securing-communication>Securing communication<a aria-label="Anchor link for: securing-communication" class=zola-anchor href=#securing-communication>#</a></h2><p>In the introduction we mentioned the ability to encrypt the communication between client and server to counter eavesdropping and ensure no third-parties are able to perform MITM attacks. Up to now, no action was taken to fulfill this requirement. To demonstrate that, we can inspect the network communication using Wireshark.<div style=width:100%;max-width:850px;margin-left:auto;margin-right:auto><img src=no_tls.png></div><p>As you may have noticed from the previous gif, some metadata is attached to the request performed by the client. Its name is <code>token</code>, and the value '03357-1'. Looking at packet 6 from the trace, it is clear that the requests and data are sent in plaintext between client and server, so no confidentiality is ensured. It is even worse the fact that somebody can impersonate either the client or the server and replace the data exchanged.<p>gRPC offers several <a rel="nofollow noreferrer" href=https://grpc.io/docs/guides/auth/>ways</a> to authenticate and secure communication. In this post we're going to see how to encrypt all the data and perform mutual authentication for client and server using TLS. This is somehow the simplest way to do so. To make it work, we have to start from certificates.<p>In TLS, certificates are issued by a trusted certificate authority (simply CA). Since we're simulating everything from scratch we assume no CA is available, hence we're going to create a valid certificate for the CA, for the server and for the client using <code>openssl</code>. We start from the CA. Let's run:<pre class=language-bash data-lang=bash style=color:#6c7079;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#eb6772>openssl</span><span style=color:#abb2bf> req</span><span style=color:#eb6772> -x509 -newkey</span><span style=color:#abb2bf> rsa:4096</span><span style=color:#eb6772> -days</span><span style=color:#abb2bf> 30</span><span style=color:#eb6772> -nodes -keyout</span><span style=color:#abb2bf> certs/ca-key.pem \
</span><span style=color:#eb6772>		-out</span><span style=color:#abb2bf> certs/ca-cert.pem</span><span style=color:#eb6772> -subj </span><span style=color:#9acc76>"/C=/ST=/L=/O=My CA/OU=/CN=/emailAddress="
</span></code></pre><p>The command creates a new private RSA key and a public x509 certificate for the CA (the <code>-subj</code> argument), saving them in pem format in the <code>cert</code> directory. Expiration is set in 30 days. To inspect their content you can run <code>openssl rsa -in certs/ca-key.pem -text</code> and <code>openssl x509 -in certs/ca-cert.pem -text</code>, respectively.<p>The process for the client and the server is slightly different, we're still creating the private and public keys using <code>openssl</code>, but we have to simulate the submission of a certificate sign request (CSR) to the CA for producing a validate certificate. This is how to do that on behalf of the server (the same applies for the client).<pre class=language-bash data-lang=bash style=color:#6c7079;background-color:#2b303b><code class=language-bash data-lang=bash><span style=color:#5f697a;font-style:italic># Server's keys + CSR
</span><span style=color:#eb6772>openssl</span><span style=color:#abb2bf> req</span><span style=color:#eb6772> -newkey</span><span style=color:#abb2bf> rsa:4096</span><span style=color:#eb6772> -nodes -keyout</span><span style=color:#abb2bf> certs/server-key.pem</span><span style=color:#eb6772> -out</span><span style=color:#abb2bf> certs/server-req.pem \
</span><span style=color:#eb6772>		-subj </span><span style=color:#9acc76>"/C=/ST=/L=/O=Server/OU=/CN=/emailAddress="
</span><span style=color:#abb2bf>		
</span><span style=color:#5f697a;font-style:italic># Inspect and verify the CSR
</span><span style=color:#eb6772>openssl</span><span style=color:#abb2bf> req</span><span style=color:#eb6772> -text -noout -verify -in</span><span style=color:#abb2bf> certs/server-req.pem
</span><span style=color:#abb2bf>
</span><span style=color:#5f697a;font-style:italic># Sign the CSR with CA's key to generate a valid certificate
</span><span style=color:#eb6772>openssl</span><span style=color:#abb2bf> x509</span><span style=color:#eb6772> -req -in</span><span style=color:#abb2bf> certs/server-req.pem</span><span style=color:#eb6772> -days</span><span style=color:#abb2bf> 30</span><span style=color:#eb6772> -CA</span><span style=color:#abb2bf> certs/ca-cert.pem \
</span><span style=color:#eb6772>		-CAkey</span><span style=color:#abb2bf> certs/ca-key.pem</span><span style=color:#eb6772> -CAcreateserial -out</span><span style=color:#abb2bf> certs/server-cert.pem \
</span><span style=color:#eb6772>		-extfile</span><span style=color:#abb2bf> certs/server-ext.cnf
</span></code></pre><p>Now that we have generated valid certificates we have to configure the server and the client to use them to setup the communication channel. We start from the server. First we create a new valid set of TLS credentials, then we inject them at gRPC server init time. The new credentials collect the private key and the public certificate of the server, as well as the public certificate of the trusted CA. It also tells the server that the client must be successfully authenticated for its requests to be served.<pre class=language-go data-lang=go style=color:#6c7079;background-color:#2b303b><code class=language-go data-lang=go><span style=color:#cd74e8>func </span><span style=color:#5cb3fa>loadTLSCreds</span><span style=color:#abb2bf>() (</span><span style=color:#eb6772>credentials</span><span style=color:#abb2bf>.</span><span style=color:#cd74e8>TransportCredentials</span><span style=color:#abb2bf>, </span><span style=color:#cd74e8>error</span><span style=color:#abb2bf>) {
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>	</span><span style=color:#eb6772>caCert</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>err </span><span style=color:#adb7c9>:= </span><span style=color:#eb6772>ioutil</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>ReadFile</span><span style=color:#abb2bf>(</span><span style=color:#9acc76>"../certs/ca-cert.pem"</span><span style=color:#abb2bf>)
</span><span style=color:#abb2bf>	</span><span style=color:#cd74e8>if </span><span style=color:#eb6772>err </span><span style=color:#adb7c9>!= </span><span style=color:#db9d63>nil </span><span style=color:#abb2bf>{
</span><span style=color:#abb2bf>		</span><span style=color:#cd74e8>return </span><span style=color:#db9d63>nil</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>err
</span><span style=color:#abb2bf>	}
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>	</span><span style=color:#eb6772>certPool </span><span style=color:#adb7c9>:= </span><span style=color:#eb6772>x509</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>NewCertPool</span><span style=color:#abb2bf>()
</span><span style=color:#abb2bf>	</span><span style=color:#cd74e8>if </span><span style=color:#adb7c9>!</span><span style=color:#eb6772>certPool</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>AppendCertsFromPEM</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>caCert</span><span style=color:#abb2bf>) {
</span><span style=color:#abb2bf>		</span><span style=color:#cd74e8>return </span><span style=color:#db9d63>nil</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>fmt</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>Errorf</span><span style=color:#abb2bf>(</span><span style=color:#9acc76>"failed to add CA's certificate"</span><span style=color:#abb2bf>)
</span><span style=color:#abb2bf>	}
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>	</span><span style=color:#eb6772>serverCert</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>err </span><span style=color:#adb7c9>:= </span><span style=color:#eb6772>tls</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>LoadX509KeyPair</span><span style=color:#abb2bf>(</span><span style=color:#9acc76>"../certs/server-cert.pem"</span><span style=color:#abb2bf>, </span><span style=color:#9acc76>"../certs/server-key.pem"</span><span style=color:#abb2bf>)
</span><span style=color:#abb2bf>	</span><span style=color:#cd74e8>if </span><span style=color:#eb6772>err </span><span style=color:#adb7c9>!= </span><span style=color:#db9d63>nil </span><span style=color:#abb2bf>{
</span><span style=color:#abb2bf>		</span><span style=color:#cd74e8>return </span><span style=color:#db9d63>nil</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>err
</span><span style=color:#abb2bf>	}
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>	</span><span style=color:#eb6772>cfg </span><span style=color:#adb7c9>:= &</span><span style=color:#eb6772>tls</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>Config</span><span style=color:#abb2bf>{
</span><span style=color:#abb2bf>		</span><span style=color:#eb6772>Certificates</span><span style=color:#abb2bf>: []</span><span style=color:#eb6772>tls</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>Certificate</span><span style=color:#abb2bf>{</span><span style=color:#eb6772>serverCert</span><span style=color:#abb2bf>},
</span><span style=color:#abb2bf>		</span><span style=color:#eb6772>ClientAuth</span><span style=color:#abb2bf>:   </span><span style=color:#eb6772>tls</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>RequireAndVerifyClientCert</span><span style=color:#abb2bf>,
</span><span style=color:#abb2bf>		</span><span style=color:#eb6772>ClientCAs</span><span style=color:#abb2bf>:    </span><span style=color:#eb6772>certPool</span><span style=color:#abb2bf>,
</span><span style=color:#abb2bf>	}
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>	</span><span style=color:#cd74e8>return </span><span style=color:#eb6772>credentials</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>NewTLS</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>cfg</span><span style=color:#abb2bf>), </span><span style=color:#db9d63>nil
</span><span style=color:#abb2bf>}
</span><span style=color:#abb2bf>
</span><span style=color:#cd74e8>func </span><span style=color:#5cb3fa>main</span><span style=color:#abb2bf>() {
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>	</span><span style=color:#5f697a;font-style:italic>/* ... */
</span><span style=color:#abb2bf>	
</span><span style=color:#abb2bf>	</span><span style=color:#5f697a;font-style:italic>// load TLS credentials
</span><span style=color:#abb2bf>	</span><span style=color:#eb6772>tlsCreds</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>err </span><span style=color:#adb7c9>:= </span><span style=color:#eb6772>loadTLSCreds</span><span style=color:#abb2bf>()
</span><span style=color:#abb2bf>	</span><span style=color:#cd74e8>if </span><span style=color:#eb6772>err </span><span style=color:#adb7c9>!= </span><span style=color:#db9d63>nil </span><span style=color:#abb2bf>{
</span><span style=color:#abb2bf>		</span><span style=color:#eb6772>log</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>Fatalf</span><span style=color:#abb2bf>(</span><span style=color:#9acc76>"Error loading TLS credentials </span><span style=color:#db9d63>%v</span><span style=color:#9acc76>"</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>err</span><span style=color:#abb2bf>)
</span><span style=color:#abb2bf>	}
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>	</span><span style=color:#5f697a;font-style:italic>// init the gRPC server
</span><span style=color:#abb2bf>	</span><span style=color:#eb6772>grpcServer </span><span style=color:#adb7c9>:= </span><span style=color:#eb6772>grpc</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>NewServer</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>grpc</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>Creds</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>tlsCreds</span><span style=color:#abb2bf>))
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>	</span><span style=color:#5f697a;font-style:italic>/* ... */
</span><span style=color:#abb2bf>}
</span></code></pre><p>Similarly to what we did for the server, we setup the client to use the certificates. We also update the <code>_getRequests()</code> and <code>_getStream()</code> methods to use a secure communication channel.<pre class=language-python data-lang=python style=color:#6c7079;background-color:#2b303b><code class=language-python data-lang=python><span style=color:#cd74e8>class </span><span style=color:#f0c678>SimpleProxy</span><span style=color:#adb7c9>:
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>    </span><span style=color:#cd74e8>def </span><span style=color:#5ebfcc>__init__</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>self</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>server</span><span style=color:#abb2bf>):
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>        </span><span style=color:#eb6772>self</span><span style=color:#abb2bf>.server </span><span style=color:#adb7c9>= </span><span style=color:#abb2bf>server
</span><span style=color:#abb2bf>        </span><span style=color:#eb6772>self</span><span style=color:#abb2bf>.ca_cert, </span><span style=color:#eb6772>self</span><span style=color:#abb2bf>.client_cert, </span><span style=color:#eb6772>self</span><span style=color:#abb2bf>.client_key </span><span style=color:#adb7c9>= </span><span style=color:#eb6772>self</span><span style=color:#abb2bf>.</span><span style=color:#eb6772>_readCertificates</span><span style=color:#abb2bf>()
</span><span style=color:#abb2bf>        </span><span style=color:#5f697a;font-style:italic># setup the new gRPC credentials
</span><span style=color:#abb2bf>        </span><span style=color:#eb6772>self</span><span style=color:#abb2bf>.grpc_credentials </span><span style=color:#adb7c9>= </span><span style=color:#abb2bf>grpc.</span><span style=color:#eb6772>ssl_channel_credentials</span><span style=color:#abb2bf>(
</span><span style=color:#abb2bf>            </span><span style=color:#eb6772>root_certificates</span><span style=color:#adb7c9>=</span><span style=color:#eb6772>self</span><span style=color:#abb2bf>.ca_cert,
</span><span style=color:#abb2bf>            </span><span style=color:#eb6772>private_key</span><span style=color:#adb7c9>=</span><span style=color:#eb6772>self</span><span style=color:#abb2bf>.client_key,
</span><span style=color:#abb2bf>            </span><span style=color:#eb6772>certificate_chain</span><span style=color:#adb7c9>=</span><span style=color:#eb6772>self</span><span style=color:#abb2bf>.client_cert)
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>    </span><span style=color:#cd74e8>def </span><span style=color:#5cb3fa>_readCertificates</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>self</span><span style=color:#abb2bf>):
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>        </span><span style=color:#cd74e8>with </span><span style=color:#5ebfcc>open</span><span style=color:#abb2bf>(</span><span style=color:#9acc76>"./certs/ca-cert.pem"</span><span style=color:#abb2bf>, </span><span style=color:#9acc76>'rb'</span><span style=color:#abb2bf>) </span><span style=color:#cd74e8>as </span><span style=color:#abb2bf>f1:
</span><span style=color:#abb2bf>            caCert </span><span style=color:#adb7c9>= </span><span style=color:#abb2bf>f1.</span><span style=color:#eb6772>read</span><span style=color:#abb2bf>()
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>        </span><span style=color:#cd74e8>with </span><span style=color:#5ebfcc>open</span><span style=color:#abb2bf>(</span><span style=color:#9acc76>"./certs/client-cert.pem"</span><span style=color:#abb2bf>, </span><span style=color:#9acc76>'rb'</span><span style=color:#abb2bf>) </span><span style=color:#cd74e8>as </span><span style=color:#abb2bf>f2:
</span><span style=color:#abb2bf>            clientCert </span><span style=color:#adb7c9>= </span><span style=color:#abb2bf>f2.</span><span style=color:#eb6772>read</span><span style=color:#abb2bf>()
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>        </span><span style=color:#cd74e8>with </span><span style=color:#5ebfcc>open</span><span style=color:#abb2bf>(</span><span style=color:#9acc76>"./certs/client-key.pem"</span><span style=color:#abb2bf>, </span><span style=color:#9acc76>'rb'</span><span style=color:#abb2bf>) </span><span style=color:#cd74e8>as </span><span style=color:#abb2bf>f3:
</span><span style=color:#abb2bf>            clientKey </span><span style=color:#adb7c9>= </span><span style=color:#abb2bf>f3.</span><span style=color:#eb6772>read</span><span style=color:#abb2bf>()
</span><span style=color:#abb2bf>            
</span><span style=color:#abb2bf>        </span><span style=color:#cd74e8>return </span><span style=color:#abb2bf>caCert, clientCert, clientKey
</span><span style=color:#abb2bf>		
</span><span style=color:#abb2bf>    </span><span style=color:#cd74e8>async def </span><span style=color:#5cb3fa>_getRequests</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>self</span><span style=color:#abb2bf>, </span><span style=color:#eb6772>locations</span><span style=color:#abb2bf>):
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>        </span><span style=color:#cd74e8>async with </span><span style=color:#abb2bf>grpc.aio.</span><span style=color:#eb6772>secure_channel</span><span style=color:#abb2bf>(</span><span style=color:#eb6772>self</span><span style=color:#abb2bf>.server, </span><span style=color:#eb6772>self</span><span style=color:#abb2bf>.grpc_credentials) </span><span style=color:#cd74e8>as </span><span style=color:#abb2bf>channel:
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>            </span><span style=color:#5f697a;font-style:italic># Init the client stub with the secure channel
</span><span style=color:#abb2bf>            stub </span><span style=color:#adb7c9>= </span><span style=color:#abb2bf>protos.satellite_pb2_grpc.</span><span style=color:#eb6772>SatelliteStub</span><span style=color:#abb2bf>(channel)
</span><span style=color:#abb2bf>
</span><span style=color:#abb2bf>            </span><span style=color:#5f697a;font-style:italic>"""...call the service..."""		
</span></code></pre><p>Let's again inspect the network traffic with Wireshark.<div style=width:100%;max-width:850px;margin-left:auto;margin-right:auto><img src=tls.png></div><p>As you can see from the result, client and server perform a TLS handshake to establish a secure channel, and all application data is sent encrypted.<p>The source code is available <a rel="nofollow noreferrer" href=https://github.com/dariofad/grpc_py_go_example>here</a>.<p>I hope you enjoyed it!</article><footer><div class=copyright><p>© 2025 Dario Facchinetti</div></footer></main><aside class=blur><nav><ul><li><a href=#what-is-grpc>What is gRPC</a><li><a href=#the-project>The project</a><li><a href=#service-interface>Service interface</a><li><a href=#server-stub-generation>Server, stub generation</a><li><a href=#serving-single-requests>Serving single requests</a> <ul><li><a href=#server>Server</a><li><a href=#client>Client</a></ul><li><a href=#implementing-a-stream>Implementing a Stream</a> <ul><li><a href=#server-1>Server</a><li><a href=#client-1>Client</a></ul><li><a href=#securing-communication>Securing communication</a></ul></nav></aside></div><script src=/js/lightense.min.js></script><script src=/js/main.js></script>